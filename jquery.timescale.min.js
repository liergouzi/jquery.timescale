/**
 * @authors patson
 */
(function(factory){"use strict";if(typeof define==='function'&&define.amd){define(['jquery'],factory)}else{factory((typeof(jQuery)!='undefined')?jQuery:window.Zepto)}}(function($){"use strict";$.fn.timescale=function(options){var opt=$.extend({},$.fn.timescale.defaults,options);var $container=$(this);var _container_width=$container.width();if(!opt.scale_spacing){opt.scale_spacing=Math.floor((_container_width-97)/96)}var _axis=$('<div class="ts-axis"></div>'),_time_detail=$('<div class="ts-point-time"></div>'),_cursor=$('<div class="ts-cursor"></div>').width(opt.scale_spacing);var _long_scale_tag=60/opt.minute_gap,_scale_count=24*_long_scale_tag;for(var i=0;i<_scale_count;i++){var time=calcScaleTime(i,opt.minute_gap);var _scale=$('<span class="ts-scale" data-time="'+time+'"></span>');_scale.width(opt.scale_spacing);_scale.height(opt.short_scale_height).css('margin-top',-(opt.short_scale_height-opt.offset));if(i%_long_scale_tag===0){_scale.addClass('ts-scale-long').height(opt.long_scale_height).css('margin-top',-(opt.long_scale_height-opt.offset));if(i%(_long_scale_tag*opt.value_gap)===0){_axis.append(_scale.append('<b>'+time+'</b>'))}else{_axis.append(_scale)}}else{_axis.append(_scale)}}_axis.append($('<span class="ts-scale ts-scale-long ts-scale-end" data-time="24:00"><b>24:00</b></span>'));_axis.append(_cursor);_axis.append(_time_detail);var _scale_array=_axis.children('span.ts-scale');if(opt.prev){$(opt.prev).click(function(){prev();return false})}if(opt.next){$(opt.next).click(function(){next();return false})}_axis.delegate('span.ts-scale','mouseover',function(event){var _scale=$(this);if(!_scale.hasClass('ts-scale-end')){_scale.width(opt.scale_spacing-1)}_time_detail.text(_scale.data('time'));var left=_scale_array.index(_scale)*(opt.scale_spacing+1);_time_detail.css('left',left-_time_detail.outerWidth()/2);_time_detail.show()});_axis.delegate('span.ts-scale','mouseout',function(event){var _scale=$(this);_time_detail.hide();if(!_scale.hasClass('ts-scale-end')){_scale.width(opt.scale_spacing)}});_axis.delegate('span.ts-scale:not(.ts-scale-end)','click',function(event){var _this=$(this);_this.addClass('active').siblings('span.active').removeClass('active');var left=(_scale_array.index(_this)*(opt.scale_spacing+1)+1);_cursor.css('left',left).show();opt.scale_click_func(_this,_this.data('time'),_this.next('span.ts-scale').data('time'));if(opt.next){if(hasNext()){$(opt.next).removeClass(opt.disable)}else{$(opt.next).addClass(opt.disable)}}if(opt.prev){if(hasPrev()){$(opt.prev).removeClass(opt.disable)}else{$(opt.prev).addClass(opt.disable)}}});_axis.width((_scale_array.length-1)*(opt.scale_spacing+1)+2);$container.append(_axis);if(opt.init_time){setTime(opt.init_time,true)}else{setTime('00:00')}function prev(){var scale=_axis.find('.ts-scale.active').prev();if(scale.length){scale.click()}}function next(){var scale=_axis.find('.ts-scale.active').next();if(scale.length&&!scale.hasClass('ts-scale-end')){scale.click()}}function hasPrev(){var scale=_axis.find('.ts-scale.active').prev();return scale.length?true:false}function hasNext(){var scale=_axis.find('.ts-scale.active').next();return scale.length&&!scale.hasClass('ts-scale-end')?true:false}function setTime(time,is_click){var pos=timeToPos(time,opt.minute_gap);if(is_click){_scale_array.eq(pos).click()}}return{setTime:setTime}};function calcScaleTime(index,gap){var hour=(index*gap-(index*gap)%60)/60,minute=(index*gap)%60;hour=hour<10?'0'+hour:hour;minute=minute<10?'0'+minute:minute;return hour+':'+minute}function timeToPos(time,gap){var timeArr=time.split(':'),hour=parseInt(timeArr[0],10),minute=parseInt(timeArr[1],10);return Math.floor(hour*60/gap+minute/gap)}$.fn.timescale.defaults={scale_click_func:function(_this,start_time,end_time){console.log('start:%s,end:%s',start_time,end_time)},minute_gap:15,value_gap:2,long_scale_height:32,short_scale_height:24,offset:4}}));